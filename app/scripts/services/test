(function(){QWait("jquery",function(){(function(b){function a(a,c,d){var f=this;return this.on("click.pjax",a,function(a){var B=b.extend({},k(c,d));B.container||(B.container=b(this).attr("data-pjax")||f);e(a,B)})}function e(a,e,c){c=k(e,c);e=a.currentTarget;if("A"!==e.tagName.toUpperCase())throw"$.fn.pjax or $.pjax.click requires an anchor element";if(!(1<a.which||a.metaKey||a.ctrlKey||a.shiftKey||a.altKey||location.protocol!==e.protocol||location.hostname!==e.hostname||e.hash&&e.href.replace(e.hash,
    "")===location.href.replace(location.hash,"")||e.href===location.href+"#")){var f={url:e.href,container:b(e).attr("data-pjax"),target:e};c=b.extend({},f,c);f=b.Event("pjax:click");b(e).trigger(f,[c]);f.isDefaultPrevented()||(d(c),a.preventDefault())}}function c(a,e,c){c=k(e,c);e=a.currentTarget;if("FORM"!==e.tagName.toUpperCase())throw"$.pjax.submit requires a form element";e={type:e.method.toUpperCase(),url:e.action,data:b(e).serializeArray(),container:b(e).attr("data-pjax"),target:e};d(b.extend({},
  e,c));a.preventDefault()}function d(a){function e(a,d){var f=b.Event(a,{relatedTarget:c});l.trigger(f,d);return!f.isDefaultPrevented()}a=b.extend(!0,{},b.ajaxSettings,d.defaults,a);b.isFunction(a.url)&&(a.url=a.url());var c=a.target,f=C(a.url).hash,l=a.context=g(a.container);a.data||(a.data={});a.data._pjax=l.selector;var m;a.beforeSend=function(b,c){"GET"!==c.type&&(c.timeout=0);b.setRequestHeader("X-PJAX","true");b.setRequestHeader("X-PJAX-Container",l.selector);if(!e("pjax:beforeSend",[b,c]))return!1;
  0<c.timeout&&(m=setTimeout(function(){e("pjax:timeout",[b,a])&&b.abort("timeout")},c.timeout),c.timeout=0);a.requestUrl=C(c.url).href};a.complete=function(b,c){m&&clearTimeout(m);e("pjax:complete",[b,c,a]);e("pjax:end",[b,a])};a.error=function(b,c,d){var f=q("",b,a);b=e("pjax:error",[b,c,d,a]);"GET"==a.type&&"abort"!==c&&b&&h(f.url)};a.success=function(c,m,k){var n="function"===typeof b.pjax.defaults.version?b.pjax.defaults.version():b.pjax.defaults.version,F=k.getResponseHeader("X-PJAX-Version"),
  g=q(c,k,a);n&&F&&n!==F?h(g.url):g.contents?(d.state={id:a.id||(new Date).getTime(),url:g.url,title:g.title,container:l.selector,fragment:a.fragment,timeout:a.timeout},(a.push||a.replace)&&window.history.replaceState(d.state,g.title,g.url),document.activeElement.blur(),g.title&&(document.title=g.title),l.html(g.contents),(n=l.find("input[autofocus], textarea[autofocus]").last()[0])&&document.activeElement!==n&&n.focus(),t(g.scripts),"number"===typeof a.scrollTo&&b(window).scrollTop(a.scrollTo),""!==
f&&(n=C(g.url),n.hash=f,d.state.url=n.href,window.history.replaceState(d.state,g.title,n.href),g=b(n.hash),g.length&&b(window).scrollTop(g.offset().top)),e("pjax:success",[c,m,k,a])):h(g.url)};d.state||(d.state={id:(new Date).getTime(),url:window.location.href,title:document.title,container:l.selector,fragment:a.fragment,timeout:a.timeout},window.history.replaceState(d.state,document.title));var k=d.xhr;k&&4>k.readyState&&(k.onreadystatechange=b.noop,k.abort());d.options=a;k=d.xhr=b.ajax(a);0<k.readyState&&
(a.push&&!a.replace&&(v(d.state.id,l.clone().contents()),window.history.pushState(null,"",n(a.requestUrl))),e("pjax:start",[k,a]),e("pjax:send",[k,a]));return d.xhr}function f(a,e){return d(b.extend({url:window.location.href,push:!1,replace:!0,scrollTo:!1},k(a,e)))}function h(a){window.history.replaceState(null,"","#");window.location.replace(a)}function l(a){if((a=a.state)&&a.container){if(r&&A==a.url||d.state.id===a.id)return;var e=b(a.container);if(e.length){var c,f=s[a.id];if(d.state){var l=c=
  d.state.id<a.id?"forward":"back",m=d.state.id,n=e.clone().contents();s[m]=n;"forward"===l?(l=y,n=z):(l=z,n=y);l.push(m);(m=n.pop())&&delete s[m]}c=b.Event("pjax:popstate",{state:a,direction:c});e.trigger(c);if(c.isDefaultPrevented())return;c={id:a.id,url:a.url,container:e,push:!1,fragment:a.fragment,timeout:a.timeout,scrollTo:!1};f?(e.trigger("pjax:start",[null,c]),a.title&&(document.title=a.title),e.html(f),d.state=a,e.trigger("pjax:end",[null,c])):d(c);e[0].offsetHeight}else h(location.href)}r=
  !1}function m(a){var e=b.isFunction(a.url)?a.url():a.url,c=a.type?a.type.toUpperCase():"GET",d=b("<form>",{method:"GET"===c?"GET":"POST",action:e,style:"display:none"});"GET"!==c&&"POST"!==c&&d.append(b("<input>",{type:"hidden",name:"_method",value:c.toLowerCase()}));a=a.data;if("string"===typeof a)b.each(a.split("&"),function(a,e){var c=e.split("=");d.append(b("<input>",{type:"hidden",name:c[0],value:c[1]}))});else if("object"===typeof a)for(key in a)d.append(b("<input>",{type:"hidden",name:key,
  value:a[key]}));b(document.body).append(d);d.submit()}function n(a){return a.replace(/\?_pjax=[^&]+&?/,"?").replace(/_pjax=[^&]+&?/,"").replace(/[\?&]$/,"")}function C(a){var e=document.createElement("a");e.href=a;return e}function k(a,e){a&&e?e.container=a:e=b.isPlainObject(a)?a:{container:a};e.container&&(e.container=g(e.container));return e}function g(a){a=b(a);if(a.length){if(""!==a.selector&&a.context===document)return a;if(a.attr("id"))return b("#"+a.attr("id"));throw"cant get selector for pjax container!";
}throw"no pjax container for "+a.selector;}function D(a,e){return a.filter(e).add(a.find(e))}function p(a){return b.parseHTML(a,document,!0)}function q(a,e,c){var d={};d.url=n(e.getResponseHeader("X-PJAX-URL")||c.requestUrl);if(/<html/i.test(a)){e=b(p(a.match(/<head[^>]*>([\s\S.]*)<\/head>/i)[0]));var f=b(p(a.match(/<body[^>]*>([\s\S.]*)<\/body>/i)[0]))}else e=f=b(p(a));if(0===f.length)return d;d.title=D(e,"title").last().text();c.fragment?(a="body"===c.fragment?f:D(f,c.fragment).first(),a.length&&
(d.contents=a.contents(),d.title||(d.title=a.attr("title")||a.data("title")))):/<html/i.test(a)||(d.contents=f);d.contents&&(d.contents=d.contents.not(function(){return b(this).is("title")}),d.contents.find("title").remove(),d.scripts=D(d.contents,"script[src]").remove(),d.contents=d.contents.not(d.scripts));d.title&&(d.title=b.trim(d.title));return d}function t(a){if(a){var e=b("script[src]");a.each(function(){var a=this.src;if(!e.filter(function(){return this.src===a}).length){var c=document.createElement("script");
  c.type=b(this).attr("type");c.src=b(this).attr("src");document.head.appendChild(c)}})}}function v(a,e){s[a]=e;for(y.push(a);z.length;)delete s[z.shift()];for(;y.length>d.defaults.maxCacheLength;)delete s[y.shift()]}function x(){return b("meta").filter(function(){var a=b(this).attr("http-equiv");return a&&"X-PJAX-VERSION"===a.toUpperCase()}).attr("content")}function u(){b.fn.pjax=a;b.pjax=d;b.pjax.enable=b.noop;b.pjax.disable=w;b.pjax.click=e;b.pjax.submit=c;b.pjax.reload=f;b.pjax.defaults={timeout:650,
  push:!0,replace:!1,type:"GET",dataType:"html",scrollTo:0,maxCacheLength:20,version:x};b(window).on("popstate.pjax",l)}function w(){b.fn.pjax=function(){return this};b.pjax=m;b.pjax.enable=u;b.pjax.disable=b.noop;b.pjax.click=b.noop;b.pjax.submit=b.noop;b.pjax.reload=function(){window.location.reload()};b(window).off("popstate.pjax",l)}var r=!0,A=window.location.href,E=window.history.state;E&&E.container&&(d.state=E);"state"in window.history&&(r=!1);var s={},z=[],y=[];0>b.inArray("state",b.event.props)&&
b.event.props.push("state");b.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);b.support.pjax?u():w()})(jQuery);(function(){window.PjaxHelper=function(){function b(){this.stackIndex=-1;this.initialTimingDebugInfo=$("#footer-timing").html();this.pjaxStateStack=[];this.initFunctionStack=[];this.lastActionWasPopstate=!1;$(document).on("pjax:send",function(a){return function(){a.pushStateToStack();
  return a.lastActionWasPopstate=!1}}(this));$(document).on("pjax:complete",function(a){return function(){return a.setBodyClasses($("#js-subpagePjaxData, #js-pjaxData").data("body-classes"))}}(this));$(document).on("pjax:popstate",function(a){return function(e){var b;$(document).one("pjax:end",function(a){return $(a.target).find("script").not('[type="text/html"]').each(function(){return $.globalEval(this.text||this.textContent||this.innerHTML||"")})});b=a.getPjaxTarget(e);a.traversePjaxStateStack("forward"===
e.direction)||e.preventDefault();a.lastActionWasPopstate=!0;if(b!==a.lastPjaxTarget)return e.preventDefault(),a.lastPjaxTarget=b,location.reload()}}(this));$(document).on("pjax:end",function(a){return function(e){a.lastPjaxTarget=a.getPjaxTarget(e);return a.updateTimingDebugInfo()}}(this));$(document).pjax("a.inner.pjax","#subpage",{timeout:0,scrollTo:!1,fragment:"#subpage"});$(document).pjax("a.pjax:not(.inner)","#page",{timeout:0})}b.prototype.getPjaxTarget=function(a){return"#"+$(a.target).attr("id")};
  b.prototype.pushStateToStack=function(){var a;this.pjaxStateStack=this.pjaxStateStack.slice(0,+this.stackIndex+1||9E9);-1===this.stackIndex&&(a={bodyClasses:$("#js-subpagePjaxData, #js-pjaxData").data("body-classes")||$("body").attr("class")},this.pjaxStateStack.push(a));return this.stackIndex=-1};b.prototype.traversePjaxStateStack=function(a){this.lastActionWasPopstate||this.pushStateToStack();a?this.stackIndex+=1:--this.stackIndex;if(a=this.pjaxStateStack[this.pjaxStateStack.length+this.stackIndex])return this.setBodyClasses(a.bodyClasses),
    !0;location.reload();return!1};b.prototype.setBodyClasses=function(a){return $("body").removeClass().addClass(a)};b.prototype.updateTimingDebugInfo=function(){return $("#footer-timing").empty().append($("#js-subpagePjaxData, #js-pjaxData").data("timing-debug")||this.initialTimingDebugInfo)};return b}()}).call(this);new PjaxHelper});QLoad("pjax");var q,t,u,v,g,w,x,r,p={}.hasOwnProperty,A=function(b,a){function e(){this.constructor=b}for(var c in a)p.call(a,c)&&(b[c]=a[c]);e.prototype=a.prototype;b.prototype=
  new e;b.__super__=a.prototype;return b},G=[].slice;QWait("jquery",function(){return function(b,a,e){var c,d,f,h;c=void 0;h={baseImageOpacity:1,overlayOpacity:.8,animationDuration:220,eventHandler:e,overlaySelector:"#image-fullscreen-cover",fullscreenImageClass:"zoom-image",getFullscreenPath:function(){return b(this).attr("src")}};d={init:function(a){null==a&&(a={});b.extend(h,a);c=b(this);f.bindEvents();return c.each(function(a,e){if(!b(e).is("img"))return b.error("jQuery.qFullscreen must be used on images")})},
  open:function(a){null==a&&(a=!1);if(!f.anyOpen())return b(this).each(function(e,c){var d;if(!b(c).data("fs-isOpen"))return f.isLoaded(c)||(b(c).after(b(c).clone().removeData().addClass(h.fullscreenImageClass)),d=h.getFullscreenPath.call(c),b("<img/>",{attr:{src:d}}).load(function(){var a,e,f;b(c).data("fs-isLoaded",!0).next().attr({src:d});a=b(c).next();f=this.width;e=this.height;if(a.width()!==f||a.height()!==e)return a={width:f,height:e},b(c).next().data(a).animate({width:f,height:e,marginTop:-1*
  e/2,marginLeft:-1*f/2},100)})),f.open(c,a),b(c).data("fs-isOpen",!0)})},close:function(a){null==a&&(a=!1);if(f.anyOpen())return b(this).each(function(e,c){if(b(c).data("fs-isOpen"))return f.close(c,a),b(c).data("fs-isOpen",!1)})}};f={anyOpen:function(){return b("body").hasClass("image-fullscreen")},isLoaded:function(a){return b(a).data("fs-isLoaded")},open:function(e,c){var d,g,k,p;null==c&&(c=!1);g=b(e);d=g.next();k=f.getImageSize(d);p=k[0];k=k[1];p=Math.min(b(a).width(),p||.9*b(a).width());k=Math.min(b(a).height(),
  k||.9*b(a).height());d.addClass("fullscreen").css({top:Math.floor(g.offset().top-b(a).scrollTop()),left:Math.floor(g.offset().left),height:g.height(),width:g.width(),opacity:h.baseImageOpacity,position:"fixed"}).show();g.addClass("fullscreened");f.toggleOverlay();g=h.animationDuration;c&&(g*=7);return d.stop().animate({height:k,width:p,marginTop:-1*k/2,marginLeft:-1*p/2,opacity:1,left:"50%",top:"50%"},g)},close:function(e,c){var d,g,k;null==c&&(c=!1);k=b(e);d=k.next();f.toggleOverlay();g=h.animationDuration;
  c&&(g*=7);return d.stop().animate({top:Math.floor(k.offset().top-b(a).scrollTop()),left:Math.floor(k.offset().left),height:k.height(),width:k.width(),marginTop:0,marginLeft:0,opacity:h.baseImageOpacity},.7*g,function(){d.hide();return k.removeClass("fullscreened")})},toggleOverlay:function(){b("body").hasClass("image-fullscreen")?b(h.overlaySelector).animate({opacity:0},h.animationDuration,function(){return b(h.overlaySelector).css("left",-5E3)}):b(h.overlaySelector).css("left",0).animate({opacity:h.overlayOpacity},
  h.animationDuration);return b("body").toggleClass("image-fullscreen")},getImageSize:function(a){var e;a=b(a);e=a.data();return null!=e&&e.width&&e.height?[e.width,e.height]:[a.attr("width"),a.attr("height")]},bindEvents:function(){if(h.eventHandler)return b(h.eventHandler).on({keydown:function(a){if(27===a.which&&f.anyOpen())return a.preventDefault(),b(h.overlaySelector).click()},click:function(a){if(c.is(a.target))return d.open.call(a.target,a.shiftKey)}}).on("click",".zoom-image.fullscreen",function(a){var e;
  e=b(a.target).prev(".fullscreened");return d.close.call(e[0],a.shiftKey)}).on("click",h.overlaySelector,function(a){return d.close.call(b(".fullscreened")[0],a.shiftKey)})}};return b.fn.qFullscreen=function(a){return d[a]?d[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!==typeof a&&a?b.error("Method "+a+" does not exist on jQuery.qFullscreen"):d.init.apply(this,arguments)}}(jQuery,window,document)});(function(){var b={options:{flagForm:"#flag-form",responses:"#problem-responses > div",
  responseBoxAppend:"-response"},initialize:function(){$(document).on("change",this.options.flagForm,this.updateForm.bind(this))},updateForm:function(){var a=$(this.options.flagForm);a.find(this.options.responses).hide();var e=a.find("select").val();a.find("."+e+this.options.responseBoxAppend).show()}};QWait("dom",b.initialize.bind(b))})();window.HighFives=function(){function b(a){this.itemType=a;$(document).on("mouseenter",".highfive a .target",function(a){return function(b){var d,f;d=$(b.currentTarget).parents(".highfive");
  if(!d.hasClass("cancelled")&&(a.timer=timeoutSet(1200,function(){d=$(b.currentTarget).parents(".highfive");if(!d.hasClass("cancelled"))return a.addHighFive(b.currentTarget)}),d.addClass("timing"),$("html").hasClass("nontransitioning")&&!d.hasClass("activated")))return f=d.find(".blue.outline"),f.stop().animate(a.fullOutline,1300)}}(this));$(document).on("mouseleave",".highfive a .target",function(a){return function(b){var d;a.timer&&clearTimeout(a.timer);b=$(b.currentTarget).parents(".highfive");
  b.removeClass("timing");$("html").hasClass("nontransitioning")&&(d=b.find(".blue.outline"),d.stop().animate(a.noOutline,240));if(b.hasClass("cancelled"))return b.removeClass("cancelled")}}(this));$(document).on("click",".highfive a .target",function(a){return function(b){var d;d=$(b.currentTarget).parents(".highfive");d.hasClass("activated")&&(a.removeHighFive(b.currentTarget),d.removeClass("clicked").addClass("cancelled"));return!1}}(this));$(document).on("click",".highfive a",function(){return!1})}
  b.prototype.noOutline={width:"22px",height:"22px",marginTop:"-11px",marginLeft:"-11px",opacity:0};b.prototype.fullOutline={width:"80px",height:"80px",marginTop:"-40px",marginLeft:"-40px",opacity:1};b.prototype.addHighFive=function(a){var e;e=$(a).parents(".highfive");a=e.data("item-id");if(!e.hasClass("activated"))return $.post("/"+this.itemType+"/"+a+"/highfives",function(a){return function(b){if(b.success&&(e.append('<span class="new count">'+b.highFiveCount+"</span>"),e.removeClass("cancelled").toggleClass("newly activated",
      b.highFived),$("html").hasClass("nontransitioning")))return e.find(".blue.outline").stop().css(a.noOutline)}}(this))};b.prototype.removeHighFive=function(a){var e;e=$(a).parents(".highfive");a=e.data("item-id");if(e.hasClass("activated"))return $.post("/"+this.itemType+"/"+a+"/highfives/delete",function(a){if(a.success)return e.children(".count").remove(),e.append('<span class="reverted count">'+a.highFiveCount+"</span>"),e.addClass("cancelled").removeClass("already newly activated timing")})};return b}();
  QWait("dom",function(){return QLoad("highfives")});null!=("undefined"!==typeof module&&null!==module?module.exports:void 0)&&(module.exports=HighFives);g=function(){function b(a){var e,b;null==a&&(a={});for(e in a)p.call(a,e)&&(b=a[e],this[e]=b)}b.create=function(a){return this.instance||(this.instance=new this(a))};b.errors={TOO_SHORT:0,SAVE_ERROR:1,NO_MIC_ACCESS:2,BAD_SAMPLE_RATE:3,BAD_ZOOM:4,MIC_MUTED:5};b.prototype.isGranted=!1;b.prototype.isRecording=!1;b.prototype.recordingData={};b.prototype.recordingTimestamp=
    0;b.prototype.webSocketUrl=null;b.prototype.soundPlayer=null;b.prototype.maxDuration=Infinity;b.prototype.minDuration=0;b.prototype.saveTimeout=Infinity;b.prototype.onIsUsable=function(a,e){};b.prototype.onStop=function(a){};b.prototype.onSave=function(a){};b.prototype.onCancel=function(){};b.prototype.onUploadFinish=function(){};b.prototype.onError=function(a,e){};b.prototype.onReady=function(){};b.prototype.onPermissionDenied=function(){};b.prototype.init=function(){};b.prototype.record=function(a){this.recordingData=
    a;this.isRecording=!0;return this.recordingTimestamp=(new Date).getTime()};b.prototype.stop=function(){return this.isRecording=!1};b.prototype.cancel=function(){return this.onCancel()};b.prototype.elapsedTime=function(a){null==a&&(a=this.recordingTimestamp);return a?(new Date).getTime()-a:0};b.prototype.hasPermission=function(){return this.isGranted};b.prototype.needsPermission=function(){};b.prototype.getVolume=function(){return 0};return b}();null!=("undefined"!==typeof module&&null!==module?module.exports:
    void 0)&&(module.exports=g);v=function(){function b(a){this.callbacks={record:a.onChunk,stop:a.onStop,cancel:a.onCancel,ready:a.onReady,micMuted:a.onMicMuted,testingResult:function(a){return function(b){return a._processTest(b)}}(this)};this.node=a.context.createScriptProcessor(a.bufferLen||4096,1,1);this.node.addEventListener("audioprocess",function(a){return function(b){return a._processAudio(b)}}(this),!1);this.worker=new Worker(a.workerPath);this.worker.onmessage=function(a){return function(b){var d,
    f,h;d=b.data;f=d.id;b=d.command;d=d.data;if("debug"===b)return console.log(d);if(b in a.callbacks&&f===a.id)return"function"===typeof(h=a.callbacks)[b]?h[b](d):void 0}}(this);this.isTestingMicrophone=!0;this.worker.postMessage({command:"init",config:{sampleRate:a.context.sampleRate}})}b.prototype.id=0;b.prototype.isRecording=!1;b.prototype.isTestingMicrophone=!1;b.prototype.mutedAlreadySent=!1;b.prototype.callbacks={};b.prototype.node=null;b.prototype.worker=null;b.prototype._processTest=function(a){if(a)return this.isTestingMicrophone=
    !1,this.callbacks.ready();if(!this.mutedAlreadySent)return this.callbacks.micMuted(),this.mutedAlreadySent=!0};b.prototype._processAudio=function(a){if(this.isRecording)return this.worker.postMessage({id:this.id,command:"record",buffer:a.inputBuffer.getChannelData(0)});if(this.isTestingMicrophone)return this.worker.postMessage({id:this.id,command:"testing",buffer:a.inputBuffer.getChannelData(0)})};b.prototype.record=function(){this.id++;this.isRecording=!0;return console.time("Start recording -> Stop recording")};
    b.prototype.stop=function(){this.isRecording=!1;console.timeEnd("Start recording -> Stop recording");return this.worker.postMessage({id:this.id,command:"stop"})};b.prototype.cancel=function(){this.isRecording=!1;return this.worker.postMessage({id:this.id,command:"cancel"})};b.prototype.connect=function(a){return this.node.connect(a)};return b}();null!=("undefined"!==typeof module&&null!==module?module.exports:void 0)&&(module.exports=v);x=function(){function b(a,e){this.socket=a;this.json({sampleRate:e,
    command:"newfile"})}b.prototype.json=function(a){return this.socket.send(JSON.stringify(a))};b.prototype.write=function(a){return this.socket.send(a)};b.prototype.close=function(a){null==a&&(a={});a.command="endfile";return this.json(a)};b.prototype.cancel=function(){return this.json({command:"cancel"})};return b}();null!=("undefined"!==typeof module&&null!==module?module.exports:void 0)&&(module.exports=x);null!=("undefined"!==typeof module&&null!==module?module.exports:void 0)&&(g=require("../plugin.inc"),
    v=require("./node.inc"),x=require("./stream.inc"));t=function(b){function a(){var e;a.__super__.constructor.apply(this,arguments);navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;this.audioContext=null!=(e=this.soundPlayer.plugin)?"function"===typeof e.getAudioContext?e.getAudioContext():void 0:void 0;if(e=null!=this.audioContext&&null!=navigator.getUserMedia&&null!=window.WebSocket)this.onIsUsable("html5",this);else this.onIsUsable(!1,
    this);e&&this._setupSocket()}A(a,b);a.prototype.workerPath="";a.prototype.keypressPadding=100;a.prototype.audioReady=!1;a.prototype.socketReady=!1;a.prototype.micPermission=!1;a.prototype.heartbeat=null;a.prototype.stream=null;a.prototype.streamBuffer=[];a.prototype.socket=null;a.prototype.source=null;a.prototype.audioContext=null;a.prototype.analyserNode=null;a.prototype.recorderNode=null;a.prototype.stop=function(){a.__super__.stop.apply(this,arguments);this.recorderNode.stop();return this.stream.close(this.recordingData)};
    a.prototype.record=function(){a.__super__.record.apply(this,arguments);this.streamBuffer=[];this.stream=new x(this.socket,this.audioContext.sampleRate);return this.recorderNode.record()};a.prototype.cancel=function(){this.recorderNode.cancel();this.streamBuffer=[];this.stream.cancel();return this.stream=null};a.prototype._setupSocket=function(){if(!this.socketReady)return this.socket=new WebSocket(this.webSocketUrl),this.socket.onmessage=function(a){return function(b){b=JSON.parse(b.data);if(null!=
      b&&b.command)switch(b.command){case "bad_sample_rate":return a.onError(g.errors.BAD_SAMPLE_RATE,b);case "finished_uploading":return a.onUploadFinish();case "done":return a.onSave(b)}}}(this),this.socket.onopen=function(a){return function(){a.socketReady=!0;intervalClear(a.heartbeat);a.heartbeat=intervalSet(3E4,function(){return a.socket.send(JSON.stringify({command:"ping"}))});return a._setupAudio()}}(this),this.socket.onerror=function(a){return function(){return a.onError(g.errors.SAVE_ERROR)}}(this),
      this.socket.onclose=function(a){return function(){a.socketReady=!1;return timeoutSet(1500,function(){return a._setupSocket()})}}(this)};a.prototype._getFreqData=function(){var a;a=new Uint8Array(this.analyserNode.frequencyBinCount);this.analyserNode.getByteFrequencyData(a);return Array.apply([],a)};a.prototype.getVolume=function(){var a,b,d,f,h,l,g;if(!this.analyserNode)return 0;a=this._getFreqData();h=0;b=[];f=0;for(l=a.length;f<l;f++)d=a[f],b.push(Math.pow(d,2));f=0;for(l=b.length;f<l;f++)d=b[f],
      h+=d;d=-Infinity;l=0;for(g=b.length;l<g;l++)f=b[l],f>d&&(d=f);b=Math.sqrt(d);return(Math.sqrt(h/a.length)+b)/510};a.prototype._setupAudio=function(){var a,b;if(!this.audioReady){b=function(a){return function(b){a.isGranted=!0;return a._setupRecording(b)}}(this);a=function(a){return function(){a.isGranted=!1;return a.onPermissionDenied()}}(this);try{return navigator.getUserMedia({audio:!0},b,a)}catch(d){return this.audioReady=!1,a()}}};a.prototype._setupRecording=function(a){var b,d;this.recorderNode=
      new v({context:this.audioContext,workerPath:this.workerPath,onChunk:function(a){return function(b){var e,c,d,g,k;e=a.elapsedTime();if(!(e<a.keypressPadding)){if(e>a.maxDuration)return a.stop();if(e<a.minDuration)return a.streamBuffer.push(b.blob);if(a.streamBuffer.length&&null!=a.stream){g=a.streamBuffer;c=0;for(d=g.length;c<d;c++)e=g[c],a.stream.write(e);a.streamBuffer=[]}return null!=(k=a.stream)?k.write(b.blob):void 0}}}(this),onStop:function(a){return function(){var b;b=a.elapsedTime();return b<
      a.minDuration?a.onError(g.errors.TOO_SHORT,{duration:b}):a.onStop(b)}}(this),onCancel:function(a){return function(){return a.onCancel()}}(this),onReady:function(a){return function(){a.audioReady=!0;return a.onReady()}}(this),onMicMuted:function(a){return function(){return a.onError(g.errors.MIC_MUTED)}}(this)});this.source=this.audioContext.createMediaStreamSource(a);d=this.audioContext.createGain();d.gain.value=0;b=this.audioContext.createChannelSplitter(2);a=this.audioContext.createChannelMerger(2);
      this.analyserNode=this._buildAnalyserNode();this.source.connect(b);b.connect(a);a.connect(this.analyserNode);this.analyserNode.connect(this.recorderNode.node);this.recorderNode.connect(d);return d.connect(this.audioContext.destination)};a.prototype._buildAnalyserNode=function(){var a;a=this.audioContext.createAnalyser();a.smoothingTimeConstant=.6;a.fftSize=1024;return a};return a}(g);null!=("undefined"!==typeof module&&null!==module?module.exports:void 0)&&(module.exports=t);null!=("undefined"!==
  typeof module&&null!==module?module.exports:void 0)&&(g=require("../plugin.inc"),global.flashembed=require("flashembed"));q=function(b){function a(){a.__super__.constructor.apply(this,arguments);this._embedSwf(function(a){return function(b){a._resolveReadyQueue(b);return b?(a.init(),a.onIsUsable("flash",a)):a.onIsUsable(!1,a)}}(this))}A(a,b);a.prototype.flash=null;a.prototype.waitForReadyQueue=[];a.prototype.FLASH_ID="flashRecordingObject";a.prototype.record=function(){var b;a.__super__.record.apply(this,
    arguments);return null!=(b=this.flash)?b._record():void 0};a.prototype.stop=function(){var b;a.__super__.stop.apply(this,arguments);return null!=(b=this.flash)?b._stop(this.recordingData):void 0};a.prototype.init=function(){return this.swf("init",{minDuration:this.minDuration,maxDuration:this.maxDuration,uploadEndpoint:this.ajaxChunkUrl,finishEndpoint:this.ajaxFinishedUrl})};a.prototype.cancel=function(){var a;return null!=(a=this.flash)?a._cancel():void 0};a.prototype.needsPermission=function(){return this.swf("showPermissions")};
    a.prototype.getLogs=function(){var a,b,d,f;f=this.flash._getLogs();b=0;for(d=f.length;b<d;b++)a=f[b],console.log(a)};a.prototype.getVolume=function(){return this.flash._getVolume()/100};a.prototype.swf=function(){var a,b,d;b=arguments[0];a=2<=arguments.length?G.call(arguments,1):[];d=function(d){return function(){d.flash["_"+b].apply(d.flash,a)}}(this);return null!=this.flash?d():this.waitForReadyQueue.push(function(a){return function(a){return a?d():console.error("Could not load call "+b+" on Flash object")}}(this))};
    a.prototype._embedSwf=function(a){var b;null==document.getElementById(this.FLASH_ID)&&(b=document.querySelector(".for-flash .recorder-container"))&&(b.innerHTML="<div id='"+this.FLASH_ID+"'></div>");return flashembed(this.FLASH_ID,{allowFullScreen:!1,src:this.swfPath,width:"216",height:"138",version:[11,0],wmode:"transparent",onEmbed:function(b){return function(c,h){var l,g;if(!c||!h.getApi())return"function"===typeof a?a(!1):void 0;l=h.getApi();g=function(c){null==c&&(c=20);return c?timeoutSet(100,
      function(){var f;return(Object.prototype.hasOwnProperty.call(l,"PercentLoaded")||null!=l.PercentLoaded)&&l.PercentLoaded()?f=intervalSet(250,function(){if(100===l.PercentLoaded())return b.flash=l,"function"===typeof a&&a(!0),intervalClear(f)}):g(--c)}):"function"===typeof a?a(!1):void 0};return g()}}(this)})};a.prototype._resolveReadyQueue=function(a){var b,d,f,h;h=this.waitForReadyQueue;d=0;for(f=h.length;d<f;d++)b=h[d],null!=b&&b(a);this.waitForReadyQueue=[]};a.prototype._sendPost=function(a){return $.ajax({url:a.url,
      data:a.data,success:a.success,error:a.error,type:"POST",dataType:"json"})};a.prototype._stop=function(){this.stop.apply(this,arguments)};a.prototype._onSave=function(){this.onSave.apply(this,arguments)};a.prototype._onStop=function(){this.onStop.apply(this,arguments)};a.prototype._onError=function(){this.onError.apply(this,arguments)};a.prototype._onCancel=function(){this.onCancel.apply(this,arguments)};a.prototype._onPermission=function(a){if(a)this.onReady();else this.onPermissionDenied()};a.prototype._post=
      function(a,b){var d,f;f=b.chunkId||0;d=function(a){return function(b){return a.flash._ajaxError(f,b)}}(this);this._sendPost({url:a,data:b,success:function(a){return function(b){return b.success?a.flash._ajaxSuccess(f,b):d(b)}}(this),error:function(a){return function(a){return d(a.responseText)}}(this)})};a.prototype._returnFocus=function(){var a;if(a=document.querySelector(".qmodal-box #recording"))a.focus(),a.blur()};return a}(g);window.FlashRecorderPlugin=q;null!=("undefined"!==typeof module&&null!==
  module?module.exports:void 0)&&(module.exports=q);u=function(){function b(a){var b,c,d;null==a&&(a={});this.settings={plugins:a.plugins||[t,q],onIsUsable:a.onIsUsable||function(){},onNotUsable:a.onNotUsable||function(){var a;return null!=(a=window.console)?"function"===typeof a.error?a.error("Cannot record audio"):void 0:void 0}};this.pluginProps={};for(b in a)p.call(a,b)&&(d=a[b],this.pluginProps[b]=d);this.methodBuffer=[];b=this.plugin={init:function(a){return function(){return a.methodBuffer.push(["init",
    arguments])}}(this),stop:function(a){return function(){return a.methodBuffer.push(["stop",arguments])}}(this),cancel:function(a){return function(){return a.methodBuffer.push(["cancel",arguments])}}(this),record:function(a){return function(b){null==b&&(b={});return a.methodBuffer.push(["record",arguments])}}(this),hasPermission:function(a){return function(){return a.methodBuffer.push(["hasPermission",arguments])}}(this),needsPermission:function(a){return function(){return a.methodBuffer.push(["needsPermission",
    arguments])}}(this),getVolume:function(a){return function(){return a.methodBuffer.push(["getVolume",arguments])}}(this)};a=function(a){return function(b){return a[b]=function(){return this.plugin[b].apply(this.plugin,arguments)}}}(this);for(c in b)p.call(b,c)&&a(c);this.initUsablePlugin()}b.prototype.initUsablePlugin=function(){var a,b;a=this.settings.plugins.shift();if(!a)return"function"===typeof(b=this.settings).onNotUsable?b.onNotUsable():void 0;this.pluginProps.onIsUsable=function(a){return function(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  e){var h,g,m;if(b){a.plugin=e;if("function"===typeof(g=a.settings).onIsUsable)g.onIsUsable(b);for(m=[];a.methodBuffer.length;)h=a.methodBuffer.shift(),g=h[0],h=h[1],m.push(a.plugin[g].apply(a.plugin,h));return m}return a.initUsablePlugin()}}(this);return a.create(this.pluginProps)};return b}();null!=("undefined"!==typeof module&&null!==module?module.exports:void 0)&&(module.exports=u);r=function(){function b(a){var b,c;null==a&&(a={});for(b in a)p.call(a,b)&&(c=a[b],this[b]=c)}b.prototype.recorder=
    null;b.prototype.isRunning=!1;b.prototype.get=function(){};b.prototype.start=function(){if(!this.isRunning)return this.isRunning=!0,this.play()};b.prototype.pause=function(){this.isRunning=!1;return this};b.prototype.stop=function(){this.isRunning=!1;return this.clear()};b.prototype.clear=function(){var a;null!=(a=this.get())&&(a.style.maxHeight=0);return this};b.prototype.draw=function(){var a,b;a=this.recorder.getVolume();null!=(b=this.get())&&(b.style.maxHeight=""+Math.round(100*a)+"%");return this};
    b.prototype.play=function(){this.draw();this.isRunning&&window.requestAnimationFrame(function(a){return function(){return a.play()}}(this));return this};return b}();null!=("undefined"!==typeof module&&null!==module?module.exports:void 0)&&(module.exports=r);w=function(){function b(a,b){null==b&&(b={});$.extend(this,b);this.$el=$(a)}b.prototype.decimals=0;b.prototype.increment=!0;b.prototype.startMs=0;b.prototype.onTick=function(a){};b.prototype.start=function(){var a;this.timer&&this.stop();a=1E3/
  Math.pow(10,this.decimals);this.startTime=(new Date).getTime();this.timer=intervalSet(a,function(a){return function(){var b,d,f;f=(a.increment?1:-1)*((new Date).getTime()-a.startTime)+a.startMs;d=Math.floor(f/1E3);b=f%1E3;a.zeroPad(d,2);d=""+d;0<a.decimals&&(d+="."+a.zeroPad(b,3).slice(0,a.decimals));a.$el.text(d);return a.onTick(f)}}(this));return this};b.prototype.stop=function(){clearInterval(this.timer);this.timer=null;return this};b.prototype.reset=function(){this.stop();return this.$el.text("0.0")};
    b.prototype.zeroPad=function(a,b){var c;null==b&&(b=2);for(c=a.toString();c.length<b;)c="0"+c;return c};return b}();null!=("undefined"!==typeof module&&null!==module?module.exports:void 0)&&(module.exports=w);window.CustomAudio={classes:{modal:{recording:"is-recording",runningLong:"running-long",tooShort:"too-short",saving:"saving",audioLoading:"audio-loading",playing:"is-playing",endScreen:"final-screen",firstCard:"first-card",lastCard:"last-card",showingWord:"showing-word",showingDefinition:"showing-definition",
    hasRecordedAudio:"has-recorded-audio",showUndo:"show-undo",hasError:"has-error"},html:{hasPermission:"has-permission",needsPermission:"needs-permission",deniedPermission:"denied-permission",zoomedOut:"flash-zoom-error",micMuted:"microphone-muted"}},currentTerm:null,numTerms:0,side:"word",permissionGranted:null,eventsReady:null,audioReady:null,recorder:null,isSaving:!1,savingTimeout:null,heartbeat:null,recording:!1,spaceHeldDown:!1,recordingTimestamp:0,durationCounter:null,tooShortTimeout:null,isOpen:!1,
    needsRights:!0,alreadyInitialized:!1,handledBadZoom:!1,showingZoomPrompt:!1,tryItTerm:null,setPage:null,minDuration:400,maxDuration:3E4,webSocketUrl:"",qecookies:null,undoToken:null,connectionPrimed:!1,init:function(b,a){this.setPage=b;if(!this.alreadyInitialized)return $.extend(this,a),this.numTerms=this.setPage.terms.length,this.canRecord||(this.needsRights=!1),$(document).on("click",".term .edit.custom-audio",function(a){return function(b){b.preventDefault();return a.showTeaser?(a.tryItTerm=$(b.target).parents(".term"),
      QModal.open($(".recording-teaser"),{containerClass:"qmodal-recording-teaser",includeClose:!0}),activityLog("set_page_open_vr_modal")):a.showTerm($(b.currentTarget).parents(".term"))}}(this)),$(document).on("click",".recording-teaser .try-it a",function(a){return function(b){b.preventDefault();QModal.close();a.canRecord=!0;a.needsRights=!0;a.showTeaser=!1;return a.showTerm(a.tryItTerm)}}(this)),$(document).on("click",".reload.button",function(a){a.preventDefault();return window.location.reload()}),
      this.alreadyInitialized=!0},ensureReady:function(){this.setupEvents();if(this.canRecord)return this.setupRecorder()},setupEvents:function(){if(!this.eventsReady)return this.eventsReady=!0,$(document).on("click",".recording .word-lang",$.proxy(this.handleClick,this,function(b){return function(){return b.showWord()}}(this))),$(document).on("click",".recording .def-lang",$.proxy(this.handleClick,this,function(b){return function(){return b.showDefinition()}}(this))),$(document).on("click",".recording .play.button",
      $.proxy(this.handleClick,this,function(b){return function(){return b.playAudio()}}(this))),$(document).on("click",".recording .stop.button",$.proxy(this.handleClick,this,function(b){return function(){return b.stopAudio()}}(this))),$(document).on("click",".recording .delete",$.proxy(this.handleClick,this,function(b){return function(){return b.deleteAudio()}}(this))),$(document).on("click",".recording .undo-delete",$.proxy(this.handleClick,this,function(b){return function(){return b.restoreAudio()}}(this))),
      $(document).on("click",".recording .next.button",$.proxy(this.handleClick,this,function(b){return function(){return b.showNextTerm()}}(this))),$(document).on("click",".recording .prev.button",$.proxy(this.handleClick,this,function(b){return function(){return b.showPrevTerm()}}(this))),$(document).on("keydown",function(b){return function(a){var e;if(!(b.$("textarea").is(":focus")||!b.isOpen||!b.permissionGranted||a.metaKey||a.altKey||a.shiftKey||a.ctrlKey)){if(b.spaceHeldDown||b.isLoading())return a.preventDefault();
      8!==(e=a.which)&&13!==e&&32!==e&&37!==e&&38!==e&&39!==e&&40!==e||a.preventDefault();if(b.isAudioPlaying()&&(b.setPage.soundPlayer.stopAll(),13===a.which))return;b.$().removeClass(b.classes.modal.showUndo).removeClass(b.classes.modal.hasError);switch(a.which){case 8:return b.deleteAudio();case 13:return b.isShowingEndScreen()?b.hideModal():b.playAudio();case 32:return b.spaceDown();case 37:return b.showPrevTerm();case 39:return b.showNextTerm();case 38:case 40:return b.flipTerm()}}}}(this)),$(document).on("keyup",
      function(b){return function(a){if(b.isOpen&&!b.$("textarea").is(":focus")&&32===a.which)return a.preventDefault(),b.spaceUp()}}(this))},setupRecorder:function(){if(!this.recorder)return this.recorder=new u({maxDuration:this.maxDuration,minDuration:this.minDuration,webSocketUrl:this.webSocketUrl,workerPath:this.workerPath,ajaxChunkUrl:this.ajaxChunkUrl,ajaxFinishedUrl:this.ajaxFinishedUrl,swfPath:this.swfPath,plugins:[t,q],soundPlayer:this.setPage.soundPlayer,onPermissionDenied:function(b){return function(){return b._handlePermissionDenied()}}(this),
      onReady:function(b){return function(){return b._handleReady()}}(this),onNotUsable:function(b){return function(){return $("html").addClass("no-recording-plugin")}}(this),onIsUsable:function(b){return function(a){var e;b.implementation=a;$("html").addClass(""+b.implementation+"-recording-plugin");if(b.needsPermission())return $("html").addClass(b.classes.html.needsPermission),null!=(e=b.recorder)?e.needsPermission():void 0}}(this),onStop:function(b){return function(a){return b._handleStop(a)}}(this),
      onCancel:function(b){return function(){return b._handleCancel()}}(this),onSave:function(b){return function(a){return b._saveSuccessful(a)}}(this),onUploadFinish:function(b){return function(){return b._uploadFinish()}}(this),onError:function(b){return function(a,e){null==e&&(e={});return b._handleErrors(a,e)}}(this)})},needsPermission:function(){return this.needsRights&&null==this.permissionGranted},_handleErrors:function(b,a){var e;a:{var c,d;d=g.errors;for(c in d)if(p.call(d,c)&&(e=d[c],e===b)){e=
      c;break a}e=void 0}e=["recording_error",{error:""+b+": "+e,data:a}];console.warn.apply(console,e);activityLog.apply(null,e);switch(b){case g.errors.TOO_SHORT:return this._tooShort();case g.errors.BAD_ZOOM:return this._zoomedOut();case g.errors.MIC_MUTED:return $("html").addClass(this.classes.html.micMuted);default:return this.showError()}},_handlePermissionDenied:function(){var b;b=$("html");this.showingZoomPrompt||b.removeClass(this.classes.html.zoomedOut);return b.addClass(this.classes.html.deniedPermission)},
    _handleReady:function(){var b;b=$("html");this.showingZoomPrompt||b.removeClass(this.classes.html.zoomedOut);b.removeClass(this.classes.html.needsPermission).removeClass(this.classes.html.micMuted).addClass(this.classes.html.hasPermission);this.audioReady=this.permissionGranted=!0;this.visualizer=new r({recorder:this.recorder,get:function(){return document.querySelector(".levels .fill")}});return this.visualizer.start()},_handleStop:function(b){this.$().removeClass(this.classes.modal.recording).removeClass(this.classes.modal.runningLong);
      timeoutSet(150,function(a){return function(){return a.resetCountdown()}}(this));this._startSaving();this.recordingTimestamp=0;return this.recording=!1},_handleCancel:function(){var b;this.$().removeClass(this.classes.modal.recording).removeClass(this.classes.modal.runningLong);timeoutSet(150,function(a){return function(){return a.resetCountdown()}}(this));this.recordingTimestamp=0;this.spaceHeldDown=!1;return null!=(b=this.visualizer)?b.start():void 0},_uploadFinish:function(){console.timeEnd("Stop recording -> Uploading finished");
      return console.time("Upload finished -> Data received")},_saveSuccessful:function(b){console.timeEnd("Upload finished -> Data received");console.log("onSave: finished upload",b,b.custom_audio_url,b.profiling);timeoutClear(this.savingTimeout);this._doneSaving();if(b.term_id===this.currentTerm.id&&b.side===this.side)return this.currentTerm.setAudioUrl(this.side,b.custom_audio_url),this.currentTerm["has_"+this.getShortSide()+"_custom_audio"]=!0,b=this.getSetpageTermCustomAudioIcon(this.currentTerm),
      b.removeClass("no-audio").removeClass("has-outdated-custom-audio").addClass("has-custom-audio"),this.showQTerm(),this.playAudio()},_tooShort:function(){this.showQTerm();this.$().removeClass(this.classes.modal.recording).addClass(this.classes.modal.tooShort);this.visualizer.start();return this.tooShortTimeout=timeoutSet(2E3,function(b){return function(){return b.$().removeClass(b.classes.modal.tooShort)}}(this))},_zoomedOut:function(){var b;if(this.handledBadZoom)return $("html").removeClass(this.classes.html.zoomedOut);
      this.showingZoomPrompt=!0;$("html").addClass(this.classes.html.zoomedOut);b=function(a){return function(){if(a.isOpen)return $(window).off("resize",b),a.showingZoomPrompt=!1,$("html").removeClass(a.classes.html.deniedPermission),a.recorder.init(),a.recorder.needsPermission()}}(this);$(window).on("resize",b);return this.handledBadZoom=!0},_startSaving:function(){this.$().addClass(this.classes.modal.saving);this.isSaving=!0;return this.savingTimeout=timeoutSet(15E3,function(b){return function(){b._doneSaving();
      return b.showError()}}(this))},_doneSaving:function(){this.isSaving=!1;return this.$().removeClass(this.classes.modal.saving)},showModal:function(){if(!this.isOpen)return QModal.open(this.$(),{containerClass:"qmodal-recording",on:{open:function(b){return function(){var a;b.isOpen=!0;if(b.needsPermission())return null!=(a=b.recorder)?a.needsPermission():void 0}}(this),close:function(b){return function(){var a;null!=(a=b.visualizer)&&a.stop();b.isOpen=!1;b.stopAudio();return b.cancelRecording()}}(this)}})},
    hideModal:function(){this.isShowingEndScreen()&&this.saveSetDescription();return QModal.close()},$:function(b){null==b&&(b=!1);return b?this.$().find(b):$(".recording")},$terms:function(){return $("#terms .term")},showError:function(){var b,a,e;if(!this.$().hasClass(this.classes.modal.hasError)){e=this.classes.modal;for(b in e)p.call(e,b)&&(a=e[b],"showingWord"!==b&&"showDefinition"!==b&&this.$().removeClass(a));this.$().addClass(this.classes.modal.hasError);return this.showModal()}},showTerm:function(b){return this.showQTerm(this.setPage.getQTermFromElement(b))},
    showQTerm:function(b,a){var e,c,d,f;null==b&&(b=this.currentTerm);null==a&&(a=this.side);if(!this.recording&&(this.ensureReady(),"word"!==a&&"definition"!==a&&(a="word"),this.currentTerm=b,d=this.index(),timeoutClear(this.tooShortTimeout),c=this.currentTerm.hasCustomAudio(a),this.$().removeClass(this.classes.modal.endScreen).removeClass(this.classes.modal.hasError).removeClass(this.classes.modal.showUndo).toggleClass(this.classes.modal.firstCard,0===d).toggleClass(this.classes.modal.lastCard,d===
      this.setPage.terms.length-1).toggleClass(this.classes.modal.showingDefinition,"definition"===a).toggleClass(this.classes.modal.showingWord,"word"===a).toggleClass(this.classes.modal.hasRecordedAudio,c),c?null!=(f=this.visualizer)&&f.stop():null!=(e=this.visualizer)&&e.start(),f="word"===a?b.getRawWord():b.getRawDefinition(),e="word"===a?b.displayRichWord():b.displayRichDefinition("none"),"definition"===a&&"photo"===this.currentTerm.def_lang&&(e=b.displayPhoto("m")),this.$(".progress").text(d+1),d=
        this.$(".card .text").html(e).removeClass("longtext verylongtext"),200<f.length?d.addClass("verylongtext"):100<f.length&&d.addClass("longtext"),this.side=a,this.showModal(),c&&!this.canRecord))return c=b.getCustomAudioCreatorLink(a),$(".other-recorder .user-link").html(c)},showNextTerm:function(){var b,a;b=this.index();if(a=this.isShowingEndScreen())return this.hideModal();if(b<this.numTerms-1)return this.showTerm(this.$terms().eq(this.index()+1));if(!a)return this.showEndScreen()},showPrevTerm:function(){var b;
      b=this.index();if(0!==b)return this.isShowingEndScreen()&&(b+=1),this.showTerm(this.$terms().eq(b-1))},showWord:function(){return this.showQTerm(this.currentTerm,"word")},showDefinition:function(){return this.showQTerm(this.currentTerm,"definition")},flipTerm:function(){if(!this.isShowingEndScreen())return this.showQTerm(this.currentTerm,"word"===this.side?"definition":"word")},index:function(){var b;return this.$terms().index($("[data-id='"+(null!=(b=this.currentTerm)?b.id:void 0)+"']"))},isShowingEndScreen:function(){return this.$().hasClass(this.classes.modal.endScreen)},
    showEndScreen:function(){return this.$().addClass(this.classes.modal.endScreen).removeClass(this.classes.modal.hasRecordedAudio)},saveSetDescription:function(){var b;b=this.$(".set-description").val();return $.ajax({method:"POST",data:{description:b},url:"/"+this.setPage.setId+"/update-description",success:function(a){return function(a){return $(".set-description").text(a.description)}}(this)})},getShortSide:function(b){null==b&&(b=this.side);return"word"===b?"word":"def"},populateAndShowTermFromServer:function(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         a){var e,c;null==a&&(a=!1);c=this.setPage.getQTermById(b.termId);c.setAudioUrl(b.side,b.customAudioUrl);c["has_"+this.getShortSide(b.side)+"_custom_audio"]=a;e=this.getSetpageTermCustomAudioIcon(c);this.canRecord?e.removeClass("has-custom-audio").removeClass("has-outdated-custom-audio"):e.remove();return this.showQTerm(c,b.side)},numTermsRecorded:function(){var b,a,e,c,d;b=0;d=this.setPage.terms;e=0;for(c=d.length;e<c;e++)a=d[e],(a.hasCustomAudio("word")||a.hasCustomAudio("def"))&&b++;return b},startRecording:function(){var b;
      if(!this.recording&&null!=this.recorder&&!this.isLoading())return this.connectionPrimed||((new Image).src=this.connectionPrimingUrl,this.connectionPrimed=!0),timeoutClear(this.tooShortTimeout),this.recording=!0,this.$().removeClass(this.classes.modal.tooShort).removeClass(this.classes.modal.runningLong).removeClass(this.classes.modal.hasRecordedAudio).addClass(this.classes.modal.recording),null!=(b=this.visualizer)&&b.stop(),this.recordingTimestamp=(new Date).getTime(),this.recordingTimer&&this.recordingTimer.stop(),
        this.recordingTimer=new w(".record-progress .elapsed-time",{decimals:1,onTick:function(a){return function(b){if(1E4>=a.maxDuration-b)return a.$().addClass(a.classes.modal.runningLong)}}(this)}),this.recordingTimer.start(),this.recorder.record({qecookies:this.qecookies,side:this.side,termId:this.currentTerm.id})},stopRecording:function(){if(this.recording)return timeoutSet(100,function(b){return function(){b.recorder.stop();console.time("Stop recording -> Audio playing");console.time("Stop recording -> Uploading finished");
      return b.recording=!1}}(this))},cancelRecording:function(){if(this.recording)return this.recordingTimer.stop(),this.recorder.cancel(),this.recording=!1},isLoading:function(){return this.isSaving||this.$().hasClass(this.classes.modal.audioLoading)},isAudioPlaying:function(){return this.$().hasClass(this.classes.modal.playing)},playAudio:function(b){var a;null==b&&(b=this.side);if((a=this.currentTerm.getAudioUrl(b))&&this.currentTerm.hasCustomAudio(b))return this.$().addClass(this.classes.modal.audioLoading),
      console.time("Downloading audio -> Playing audio"),this.setPage.soundPlayer.preload(a,{onError:function(a){return function(){a.$().removeClass(a.classes.modal.audioLoading);return alert("Sorry, we couldn't play that recording right now. Please try again later.")}}(this),onLoad:function(b){return function(c){var d;console.timeEnd("Downloading audio -> Playing audio");console.timeEnd("Stop recording -> Audio playing");d=Math.max(1,Math.floor(c/1E3));b.$(".play-progress .total-time").text(10>d?"0"+d:
      d);$("html").hasClass("nontransitioning")?b.$(".playback .fill").stop().css({left:"-100%"}).animate({left:"0"},c,"linear"):(c=""+c+"ms",b.$(".playback .fill").css({"-webkit-animation-duration":c,"-moz-animation-duration":c,"-o-animation-duration":c,"-ms-animation-duration":c,"animation-duration":c}));b.$().removeClass(b.classes.modal.audioLoading).addClass(b.classes.modal.playing);c=function(){return b.$().removeClass(b.classes.modal.playing)};return b.setPage.soundPlayer.play(a,{onStop:c,onError:c,
      onFinish:c})}}(this)})},stopAudio:function(){this.setPage.soundPlayer.stopAll();return this.$(".playback .fill").stop()},deleteAudio:function(){var b;if(this.currentTerm.hasCustomAudio(this.side))return this.setPage.soundPlayer.stopAll(),null!=(b=this.visualizer)&&b.start(),this.$().removeClass(this.classes.modal.hasRecordedAudio),$.ajax({type:"POST",url:"/"+this.setPage.setId+"/unlink-custom-audio",data:{side:this.side,termId:this.currentTerm.id},success:function(a){return function(b){a.undoToken=
      b.undoToken;a.populateAndShowTermFromServer(b);return a.$().addClass(a.classes.modal.showUndo)}}(this)})},restoreAudio:function(){if(this.undoToken&&this.$().hasClass(this.classes.modal.showUndo)&&!this.currentTerm.hasCustomAudio(this.side)&&!this.recording)return this.$().addClass(this.classes.modal.audioLoading).removeClass(this.classes.modal.showUndo),$.ajax({type:"POST",url:"/"+this.setPage.setId+"/relink-custom-audio",data:{undoToken:this.undoToken},success:function(b){return function(a){b.$().removeClass(b.classes.modal.audioLoading);
      b.undoToken=null;return b.populateAndShowTermFromServer(a,!0)}}(this)})},getSetpageTermCustomAudioIcon:function(b){return $(".term[data-id="+b.id+"]")},resetCountdown:function(){var b;return null!=(b=this.recordingTimer)?b.reset():void 0},elapsedTime:function(b){null==b&&(b=this.recordingTimestamp);return b?(new Date).getTime()-b:0},handleClick:function(b,a){if(this.spaceHeldDown||this.isLoading())return a.preventDefault();this.isAudioPlaying()&&this.setPage.soundPlayer.stopAll();$(a.target).hasClass("undo-delete")||
    this.$().removeClass(this.classes.modal.showUndo);this.$().removeClass(this.classes.modal.hasError);return"function"===typeof b?b(a):void 0},spaceDown:function(){if(!this.spaceHeldDown){if(!this.audioReady)return this.showError();this.startRecording();return this.spaceHeldDown=!0}},spaceUp:function(){if(this.spaceHeldDown)return this.stopRecording(),this.spaceHeldDown=!1}};QLoad("CustomAudio");window.SetPage=function(){function b(a,b){$.extend(this,a);this.terms=QTerm.dataToArray(b);this.soundPlayer=
    new AudioPlayer;this.isPlayingAudio=!1;this.queuedAudio=null;this.updateNotificationDisplay();timeoutSet(400,function(a){return function(){return a.handleBlockedSocial()}}(this));this.bindPjaxEvents();this.bindEvents();this.bindTools();this.bindEmail();this.bindTeacher();this.bindInfo();this.bindFullscreenImages();this.loadDashboardNav();this.loadUpsellModal();new HighFives("set")}b.prototype.loadDashboardNav=function(){var a,b;a=$(".empty.side-nav");if(a.length)return b=$(".side-nav-wrapper"),a.html(b.html()).removeClass("empty"),
    b.remove(),$(".side-nav .pjax").removeClass("pjax")};b.prototype.loadUpsellModal=function(){var a;a=$(".ClassProgressUpsellModal");if(a.length)return QModal.open(a,{includeClose:!0,containerClass:"is-wide"}),QModal.on("close",function(){Cookie.write("cp_upsell_x","true",{duration:365,path:"/"});return activityLog("cp_upsell_x")})};b.prototype.playAudio=function(a,b,c,d,f){var h,g,m,n,p;null==d&&(d=!1);null==f&&(f=!0);if("word"!==b&&"definition"!==b||this.isPlayingAudio&&!d)return $.Deferred().reject();
    n=this.getQTermFromElement(a);c={word:null!=n?n.getAudioUrl("word",c):void 0,definition:null!=n?n.getAudioUrl("definition",c):void 0};c.word&&this.soundPlayer.preload(c.word);c.definition&&this.soundPlayer.preload(c.definition);h=a.find(".play-audio .icon");g=a.find("."+b).children("span");p=$.Deferred();c=c[b];if(!c)return h.removeClass("playing"),this.isPlayingAudio=!1,p.resolve();h.addClass("playing");g.addClass("playing");m=function(a){return function(){a.isPlayingAudio=!1;h.removeClass("playing");
      return g.removeClass("playing")}}(this);this.isPlayingAudio=!0;this.soundPlayer.play(c,{onFinish:function(a){return function(){m();return p.resolve()}}(this),onStop:m,onError:function(c){return function(){m();n[{definition:"def_audio",word:"word_audio"}[b]]=!1;c.toggleAudioClasses(a);if(!f)return alert("Sorry, we couldn't play that audio. Try checking your language settings or send us some feedback if this happens frequently.")}}(this)});return p.promise()};b.prototype.stopAudio=function(){this.soundPlayer.stopAll();
    clearTimeout(this.queuedAudio);$(".play-audio .playing").removeClass("playing");return this.isPlayingAudio=!1};b.prototype.toggleAudioClasses=function(a){var b,c,d,f,h,g;h=this.getQTermFromElement(a);c=$(".qWord",a);b=$(".qDef",a);f={word:c,definition:b};c=!1;for(g in f)b=f[g],(d=!!h.getAudioUrl(g))&&(c=!0),b.parent().toggleClass("has-audio",d).toggleClass("no-audio",!d);return a.toggleClass("has-audio",c).toggleClass("no-audio",!c)};b.prototype.isCurrentTab=function(a){return $(document.body).hasClass(""+
  a+"-tab")};b.prototype.handleBlockedSocial=function(){var a,b,c,d;c={twitter:"https://twitter.com",facebook:"https://www.facebook.com"};d=[];for(a in c)b=c[a],d.push(function(a,b){var e;e=new Image;e.onerror=function(){return $(".destinations ."+a).hide()};return e.src=""+b+"/favicon.ico"}(a,b));return d};b.prototype.updateNotificationDisplay=function(){$.extend(this,this.readCookieData());return this.notificationCount?$("li.activity-tab .chats .count").text(this.notificationCount):$("li.activity-tab .chats").remove()};
    b.prototype.disableFiltering=function(){return $(document.body).removeClass("has-selected").addClass("none-selected").addClass("show-all")};b.prototype.deselectAll=function(a){a.preventDefault();$("#terms .term").removeClass("selected");$("#terms .chunk").removeClass("selected").removeClass("some-selected");return this.resetSelections()};b.prototype.recountSelectedTerms=function(){var a;this.numSelected=$("#terms .selected.term").length;$(".selected-count").html(this.numSelected);a=$(document.body);
      a.toggleClass("singular-selected",1===this.numSelected);a.toggleClass("plural-selected",1!==this.numSelected);this.numSelected?a.hasClass("has-selected")||(a.addClass("has-selected"),a.removeClass("none-selected")):(this.disableFiltering(),this.changeModeLinkToSelected(!1));if("replaceState"in window.history)return window.history.replaceState({},window.title)};b.prototype.changeModeLinkToSelected=function(a){this.studySelected=a;$(document.body).toggleClass("study-stars-only",this.studySelected);
      $(document.body).toggleClass("study-all-terms",!this.studySelected);return this.writeCookieData({studySelected:this.studySelected})};b.prototype.updateChunkStyles=function(a){var b,c;b=$(".term",a);c=b.not(".selected");b=b.filter(".selected");a.toggleClass("selected",!c.length);return a.toggleClass("some-selected",!!b.length)};b.prototype.syncSelectionsForChunk=function(a){var b,c;c=$(".term",a);b=c.filter(".selected");c=c.not(".selected");a.toggleClass("selected",!c.length);a.toggleClass("some-selected",
      !!b.length);b.length&&this.saveSelection(b,!0);if(c.length)return this.saveSelection(c,!1)};b.prototype.saveSelection=function(a,b){var c;a.toggleClass("selected",b);var d,f,g;g=[];d=0;for(f=a.length;d<f;d++)c=a[d],g.push($(c).data("id"));$.post(b?"/selected-terms":"/selected-terms/delete",{setIds:this.setId,termIds:g.join(","),source:3,PrPadding:1});return this.recountSelectedTerms()};b.prototype.resetSelections=function(){$.post("/selected-terms/reset",{setIds:this.setId,termIds:"",source:3,PrPadding:1});
      return this.recountSelectedTerms()};b.prototype.writeCookieData=function(a){a=$.extend({},this.readCookieData(),a);return Cookie.write("setPageData",JSON.stringify(a),{path:"/"+this.setId+"/",duration:30})};b.prototype.readCookieData=function(){return JSON.parse(Cookie.read("setPageData"))};b.prototype.deleteCookieData=function(){return Cookie.dispose("setPageData",{path:"/"+this.setId+"/"})};b.prototype.bindFullscreenImages=function(){return $(".photo img").qFullscreen({getFullscreenPath:function(){return $(this).data("srcset")}})};
    b.prototype.watchScroll=function(){if(!$(document.body).hasClass("slow"))return $(window).scroll($.throttle(350,function(a){return function(){return a.measureScrollDistance(a.headerHeight)}}(this)))};b.prototype.measureScrollDistance=function(a){var b;b=$(window).scrollTop();return $(document.body).toggleClass("scrolled-down",b>a)};b.prototype.bindPjaxEvents=function(){return $(document).on({"pjax:send":function(a){return function(){return a.stopAudio()}}(this),"pjax:complete":function(a){return function(){$.extend(a,
      a.readCookieData());a.updateNotificationDisplay();return a.bindFullscreenImages()}}(this)})};b.prototype.bindEvents=function(){$("#page").on("mouseenter",".term .details a",function(a){var b,c;b=$(a.currentTarget);if(!b.find(".popout").length)return a=(c=b.attr("title"))?$(".term-detail-tooltips").find(".tooltip.blank").clone().find(".tip").text(c).end().html():$(".term-detail-tooltips").find(".tooltip."+a.currentTarget.className.replace(" ",".")).html(),b.append('<div class="popout">'+a+"</div>")});
      $("#page").on("mouseleave",".term .details a",function(a){return $(a.currentTarget).find(".popout").remove()});$("#page").on("click",".study-starred.segmented-control a",function(a){return function(b){b.preventDefault();b=$(b.currentTarget);if($(document.body).hasClass("has-selected"))return a.changeModeLinkToSelected(b.hasClass("study-selected"))}}(this));$(document).on("click",".embed-tool, .report-tool, .report .link",function(a){a.preventDefault();return $.ajax({method:"GET",url:$(a.currentTarget).attr("href"),
        success:function(a){return QModal.open(a,{includeClose:!0})}})});$("#page").on("click",".layout.segmented-control a",function(a){return function(b){var c;b.preventDefault();c=$("#terms");b=$(b.currentTarget);c.toggleClass("layout-grid",b.hasClass("layout-grid"));c.toggleClass("layout-list",b.hasClass("layout-list"));return a.writeCookieData({layout:b.hasClass("layout-grid")?"grid":"list"})}}(this));$("#page").on("click",".clear-selection",function(a){return function(b){return a.deselectAll(b)}}(this));
      $("#page").on("click",".star-chunk",function(a){return function(b){b.stopPropagation();b.preventDefault();b=$(b.currentTarget).parents(".chunk");$(".term",b).toggleClass("selected",!b.hasClass("selected"));return a.syncSelectionsForChunk(b)}}(this));$("#page").on("click","#terms .star",function(a){return function(b){var c,d,f,g,l,m;b.stopPropagation();b.preventDefault();m=$(b.currentTarget).parents(".term");d=m.parents(".chunk");d.length&&a.updateChunkStyles(d);l=!m.hasClass("selected");c=b.shiftKey;
        b=$("#terms .last-clicked");c&&b.length?(c=$("#terms .term"),f=c.index(m),g=c.index(b),c=c.slice(Math.min(f,g),Math.max(f,g)+1)):c=m;a.saveSelection(c,l);a.updateChunkStyles(d);b.removeClass("last-clicked");m.addClass("last-clicked");return!1}}(this));$("#page").on("click","#show-hidden",function(a){return function(a){a.preventDefault();$(document.body).addClass("show-all");return window.scrollTo(0,1)}}(this));$("#page").on("click","#terms .reveal-overflow",function(a){return function(a){a.preventDefault();
        $(a.currentTarget).hide();return $(".hidden.overflow").removeClass("hidden")}}(this));$("#page").on("click",".play-audio",function(a){return function(b){var c,d,f,g;b.preventDefault();c=$(b.currentTarget);d=c.find(".icon").hasClass("playing");a.stopAudio();if(!d)return g=c.parents(".term"),f=b.shiftKey?"slow":"normal",a.playAudio(g,"word",f).then(function(){a.isPlayingAudio=!0;c.find(".icon").addClass("playing");clearTimeout(a.queuedAudio);return a.queuedAudio=timeoutSet(400,function(){return a.playAudio(g,
        "definition",f,!0)})})}}(this));$("#page").on("touchstart",".term",function(a){return function(b){var c;c=a.getQTermFromElement($(b.currentTarget));b=null!=c?c.getAudioUrl("word"):void 0;c=null!=c?c.getAudioUrl("definition"):void 0;b&&a.soundPlayer.preload(b);if(c)return a.soundPlayer.preload(c)}}(this));$("#page").on("click",".terms .qDef, .terms .qWord",function(a){return function(b){var c,d;b.preventDefault();c=$(b.currentTarget);if(a.editing)return b=c.parents(".term"),a.editTerm(b,!0,c.hasClass("qDef")),
        !1;d=c.hasClass("playing");a.stopAudio();if(!d)return d=c.parent().hasClass("word")?"word":"definition",b=b.shiftKey?"slow":"normal",a.playAudio(c.parents(".term"),d,b,!1,!1)}}(this));$("#page").on("click",".term .edit.inline-term",function(a){return function(b){b.preventDefault();b=$(b.currentTarget).parents(".term");return a.editing?a.endEditingTerm(b,!0):a.editTerm(b,!0)}}(this));$("#page").on("click",".term .done",function(a){return function(b){b.preventDefault();b=$(b.currentTarget).parents(".term");
        return a.endEditingTerm(b,!0)}}(this));$("#page").on("click",".terms-ajax",function(a){a.preventDefault();return $.pjax({container:"#subpage",scrollTo:!1,fragment:"#subpage",timeout:0,url:$(a.currentTarget).data("href")})});$(document.body).on("click",function(a){return function(b){if(a.editing&&!$(".qWordTextarea:focus, .qDefTextarea:focus").length&&!$(b.target).parents(".term").length)return a.endEditingTerm($(".editing.term"),!0)}}(this));$("#page").on("click",".ordering .pjax",function(a){return $(a.target).parents(".poppable").removeClass("opened")});
      return $(document).on("keydown",function(a){return function(b){switch(b.which){case 27:b.preventDefault();a.stopAudio();if(a.editing)return a.endEditingTerm($(".editing.term"),!1);break;case 13:if(a.editing){if(b.metaKey)return a.endEditingTerm($(".editing.term"),!0);if(b.shiftKey)break;b=$(".editing.term");if(!b.find("textarea:focus").val().match(/\n/))return a.endEditingTerm(b,!0)}}}}(this))};b.prototype.editTerm=function(a,b,c){null==b&&(b=!1);null==c&&(c=!1);this.editing&&this.endEditingTerm($(".editing.term"),
      b);a.addClass("editing");this.editing=!0;$(".done",a).length?(b=a.data("id"),b=this.getQTermById(b),$(".qWordTextarea",a).val(b.getRawWord()),$(".qDefTextarea",a).val(b.getRawDefinition()),$(".qWordSizer .the-text",a).html(b.displayWord()),$(".qDefSizer .the-text",a).html(b.displayDefinition())):($(".text",a).append('<a class="done"><span class="glyph icon check-icon ">&#xe038;</span></a>'),this.textareaify(a));a=$(c?".qDefTextarea":".qWordTextarea",a).focus();return setCaretPosition(a[0],a.val().length)};
    b.prototype.textareaify=function(a){var b,c;b=a.data("id");c=this.getQTermById(b);b=function(a,b,c){return'<span class="'+a+'Sizer sizer">\n\t<span class="the-text '+b+'">'+c+'</span>\n\t<span class="textarea-wrapper '+b+'">\n\t\t<textarea class="'+a+'Textarea">'+c+"</textarea>\n\t</span>\n</span>"};$(".qWord",a).after(b("qWord",c.getLangClass("word"),c.displayWord()));$(".qDef",a).after(b("qDef",c.getLangClass("definition"),c.displayDefinition()));$(".the-text",a).append("<br>");b=function(a){return function(a){var b;
      b=$(a.target);b.scrollTop=0;a=b.parents(".sizer");return $(".the-text",a).html(htmlescape(b.val())+"<br>")}}(this);$("textarea",a).on("input",b);if($("html").hasClass("ie")&&$("html").hasClass("old"))return $("textarea",a).on("keyup",b)};b.prototype.endEditingTerm=function(a,b){b&&this.saveTerm(a);a.removeClass("editing");return this.editing=!1};b.prototype.saveTerm=function(a){var b,c,d,f;f=this.getQTermById(a.data("id"));d=$(".qWordTextarea",a).val();c=$(".qDefTextarea",a).val();if(d||c)if(b={onSuccess:function(b){return function(){var e,
        g;b.toggleAudioClasses(a);d&&(e=$(".qWord",a),g=f.displayRichWord(),$(g).html()!==e.html()&&e.replaceWith(g));c&&(e=$(".qDef",a),g=f.displayRichDefinition("none"),$(g).html()!==e.html()&&e.replaceWith(g));if("replaceState"in window.history)return window.history.replaceState({},window.title)}}(this)},d&&(b.word=d),c&&(b.definition=c),f.saveEdit(b)&&(d&&(f.word=$.trim(d),$(".qWord",a).replaceWith(f.displayRichWord())),c))return f.definition=$.trim(c),$(".qDef",a).replaceWith(f.displayRichDefinition("none"))};
    b.prototype.getQTermById=function(a){var b,c,d,f;f=this.terms;c=0;for(d=f.length;c<d;c++)if(b=f[c],b.id===a)return b};b.prototype.getQTermFromElement=function(a){return this.getQTermById(a.data("id"))};b.prototype.bindTeacher=function(){return $(document).on("change",".page-top select",function(a){return $.pjax({url:a.currentTarget.value,container:"#page",scrollTo:!1,timeout:0})})};b.prototype.bindTools=function(){$(document).on("click",".folder-tool",function(a){a.preventDefault();return QModal.open($(".add-to-folders-modal"),
      {includeClose:!0})});$(document).on("click",".share-tool",function(a){a.preventDefault();return QModal.open($(".share-tool-modal"),{includeClose:!0})});$(document).on("click",".class-tool",function(a){a.preventDefault();return QModal.open($(".add-to-classes-modal"),{includeClose:!0})});$(document).on("click",".qmodal-content .create-folder",function(a){a.preventDefault();$(a.currentTarget);QModal.open($(".new-folder-modal"),{includeClose:!0});return $(".qmodal-content").find("input").focus()});$(document).on("submit",
      ".new-folder-form",function(a){a.preventDefault();a=$(a.currentTarget);return $.post(a.attr("action"),a.serialize(),function(a){return a.success?window.location=a.path:window.alert(a.errors.join(", "))})});$(document).on("click",".share.tool .short-url",function(a){return $("input",a.currentTarget).select()});if(!this.isLoggedIn)return $(document).on("click",".copy-tool",function(a){a.preventDefault();return QModal.open($(".signup-to-copy-modal"),{includeClose:!0})})};b.prototype.bindEmail=function(){return $(document).on("submit",
      "form.email",function(a){var b,c,d;a.preventDefault();b=$(a.currentTarget.recipient);c=$(a.currentTarget);if(!b.val())return b.focus();d=function(a){b.val("");return c.find(".email-confirmation").toggleClass("error",!a.success).html("<p>"+a.message+"</p>")};return $.ajax({method:"POST",url:c.attr("action"),data:c.serialize()+"&js=1",success:d,error:function(a){a=JSON.parse(a.responseText);return d({success:!1,message:a.error_description})}})})};b.prototype.bindInfo=function(){this.bindDiscussion();
      this.bindClearDiscussion();return $(document).on("click",".info-tab .meta .more",function(a){a.preventDefault();return $(a.target).hide().next(".extra").slideDown()})};b.prototype.bindClearDiscussion=function(){return $(document).on("click",".report .clear-all",function(a){a.preventDefault();if(window.confirm("Are you sure you want to clear all discussion on this set?"))return $.ajax({url:a.currentTarget.href,type:"POST",success:function(a){return a.success?window.location.reload():alert(a.errors.join(", "))}})})};
    b.prototype.bindDiscussion=function(){this.discussionInterval=this.discussionInitial=3E3;this.isCurrentTab("info")&&(this.discussionTimer=timeoutSet(this.discussionInterval,function(a){return function(){return a.getMessages()}}(this)));$(document).on("keypress","#discussion-message",function(a){return function(b){if(13===b.which)return b.preventDefault(),a.sendMessage()}}(this));$(document).on("click","#discussion-submit",function(a){return function(b){return a.sendMessage()}}(this));$(document).on("click",
      ".expand-messages",function(a){a.preventDefault();return $(a.currentTarget).parents(".messages").removeClass("collapsed")});$("#page").on("change","#toggle-discussion .invisible-checkbox",function(a){return function(b){var c;c=$("#toggle-discussion");return $.post(c.attr("action"),c.serialize(),function(b){b=$(".invisible-checkbox",c).is(":checked");c.add("#writeChat").add("aside.discussion").toggleClass("disabled",!b);return a.showNoDiscussionMessage()})}}(this));return $("#page").on("click",".message .delete",
      function(a){return function(b){var c;b.preventDefault();c=$(b.currentTarget);return $.post(c.attr("href"),function(){var b;b=c.parents(".messages");2>b.find(".message").length?b.is("#new-messages-container")?(b.addClass("empty"),c.parents(".message").remove()):b.fadeOut(200,function(){$(a).find(".report").remove();$(a).prev(".timestamp-block").remove();$(a).remove();return a.showNoDiscussionMessage()}):(c.parents(".message").fadeOut(200,function(){return $(this).remove()}),b=parseInt($(".discussion .more-count").text(),
        10)-1,0<b?$(".expand-messages").html(pluralize(b,'<span class="more-count">1</span> more message','<span class="more-count">'+b+"</span> more messages")):$(".expand-messages").remove());return a.showNoDiscussionMessage()})}}(this))};b.prototype.showNoDiscussionMessage=function(){return $(".discussion").toggleClass("no-messages",0===$(".discussion .message").length)};b.prototype.sendMessage=function(){var a,b,c;c=$("#discussion-message");a=$("#discussion-submit");b=$.trim(c.val());if(""!==b&&!alertIfContainsProfanity(b)&&
      !a.hasClass("sending"))return timeoutClear(this.discussionTimer),a.addClass("sending"),$.ajax({type:"POST",url:"/"+this.setId+"/discussion",data:{text:b,lastId:this.lastDiscussionId},success:function(b){return function(e){timeoutSet(1E3,function(){return a.removeClass("sending")});c.focus().val("");return e.success?b.receiveMessages(e.content):alert(e.errors[0])}}(this)})};b.prototype.getMessages=function(){return $.ajax({url:"/"+this.setId+"/discussion",data:{lastId:this.lastDiscussionId},success:function(a){return function(b){return a.receiveMessages(b.content)}}(this)})};
    b.prototype.receiveMessages=function(a){a?($(".discussion.no-messages").removeClass("no-messages"),this.lastDiscussionId=parseInt($("#new-messages").prepend(a).find("article.message").first().data("id"),10),$("#new-messages-container").removeClass("empty"),this.discussionInterval=this.discussionInitial,this.writeCookieData({notificationCount:0,lastIdSeen:this.lastDiscussionId}),this.updateNotificationDisplay()):3E4>this.discussionInterval&&(this.discussionInterval*=1.2);return this.discussionTimer=
      timeoutSet(this.discussionInterval,function(a){return function(){return a.getMessages()}}(this))};return b}();QLoad("SetPage")}).call(this);
